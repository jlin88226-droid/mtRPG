<!doctype html>
<html lang="zh-Hant" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èœœæ¡ƒå¿«é€ƒRPG</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body { box-sizing: border-box; }
    
    @keyframes popIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    @keyframes jelly {
      0% { transform: scale(1); }
      30% { transform: scale(1.12, 0.9); }
      50% { transform: scale(0.95, 1.05); }
      70% { transform: scale(1.05, 0.97); }
      100% { transform: scale(1); }
    }
    
    @keyframes peachFloat {
      from { transform: translateY(100%) rotate(0deg); }
      to { transform: translateY(-120px) rotate(360deg); }
    }
    
    @keyframes cloudFloat {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-200px); }
    }
    
    .story-box { animation: popIn 0.35s ease-out; }
    .btn:active { animation: jelly 0.45s; }
    
    .peach {
      position: absolute;
      opacity: 0.35;
      animation: peachFloat linear infinite;
      pointer-events: none;
    }
    
    body.dead .peach {
      animation-play-state: paused;
      opacity: 0.15;
    }

    .cloud {
      position: absolute;
      opacity: 0.7;
      animation: cloudFloat linear infinite;
      pointer-events: none;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div class="w-full h-full overflow-auto" style="background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 40%, #90EE90 70%, #228B22 100%);">
   <div class="fixed inset-0 pointer-events-none overflow-hidden" style="z-index: 0;">
    <div class="absolute" style="top: 40px; right: 80px; font-size: 80px; opacity: 0.9;">â˜€</div>
    <div class="cloud" style="top: 60px; font-size: 60px; animation-duration: 40s;">â˜</div>
    <div class="cloud" style="top: 100px; font-size: 50px; animation-duration: 50s; animation-delay: -10s;">â˜</div>
    <div class="cloud" style="top: 80px; font-size: 55px; animation-duration: 45s; animation-delay: -25s;">â˜</div>
    <div class="absolute bottom-0 left-0 right-0 text-4xl" style="line-height: 0.8;">ğŸŒ¿ğŸŒ±ğŸŒ¾ğŸŒ¿ğŸŒ±ğŸŒ¾ğŸŒ¿ğŸŒ±ğŸŒ¾ğŸŒ¿ğŸŒ±ğŸŒ¾ğŸŒ¿ğŸŒ±ğŸŒ¾ğŸŒ¿ğŸŒ±ğŸŒ¾ğŸŒ¿ğŸŒ±ğŸŒ¾ğŸŒ¿ğŸŒ±ğŸŒ¾</div>
    <span class="peach text-xl" style="left: 5%; animation-duration: 18s;">ğŸ‘</span> 
    <span class="peach text-2xl" style="left: 20%; animation-duration: 22s;">ğŸ‘</span> 
    <span class="peach text-xl" style="left: 35%; animation-duration: 16s;">ğŸ‘</span> 
    <span class="peach text-3xl" style="left: 55%; animation-duration: 25s;">ğŸ‘</span> 
    <span class="peach text-2xl" style="left: 70%; animation-duration: 19s;">ğŸ‘</span> 
    <span class="peach text-lg" style="left: 85%; animation-duration: 27s;">ğŸ‘</span>
   </div>

   <div class="relative w-full max-w-md mx-auto px-5 pt-5 pb-48" style="z-index: 1;">
    
    <div id="page-title" class="page">
     <div class="text-center mb-8">
      <h1 id="main-title" class="text-4xl font-bold mb-2" style="color: #ff6b9d;">èœœæ¡ƒå¿«é€ƒRPG</h1>
      <p id="main-subtitle" class="text-lg" style="color: #ff9eb5;">ä¸€å€‹å……æ»¿å±éšªèˆ‡ç”œèœœçš„å†’éšª</p>
     </div>
     <div class="rounded-2xl p-4 mb-4" style="background-color: #fff1f3;">
      <p class="text-base leading-relaxed" style="color: #444;">ä½ æ˜¯ä¸€é¡†å¹³å¹³ç„¡å¥‡çš„æ°´èœœæ¡ƒğŸ‘ï¼Œä»Šå¤©ä¸€æ¨£åœ¨å»šæˆ¿çš„æ°´æœç±ƒè£¡ç•¶å®‰éœçš„ç¾å¥³å­ã€‚çªç„¶å¤©å¤–ä¸€è²é©šé›·éŸ¿âš¡ï¼Œé€™å€‹å®¶çš„å°ä¸»äººçªç„¶é–‹å§‹å¤§å–Šã€Œæˆ‘è¦åƒæ°´èœœæ¡ƒï¼ï¼ã€å®Œè›‹äº†ï¼Œç¾åœ¨æ°´æœç±ƒè£¡åªå‰©ä½ é€™é¡†æ¡ƒï¼Œå†ä¸é€ƒï¼Œæ¡ƒå‘½ä¸ä¿...</p>
     </div>
     <div class="rounded-2xl p-3" style="background-color: #ffe5ec;">
       <button class="btn w-full py-3 px-4 my-2 rounded-xl text-lg font-semibold transition-all" style="background-color: #ffb6c9; color: #fff;" onclick="startGame()"> ğŸ® é–‹å§‹å†’éšª </button> 
       <button class="btn w-full py-3 px-4 my-2 rounded-xl text-lg font-semibold transition-all" style="background-color: #ffb6c9; color: #fff;" onclick="showPage('endings')"> ğŸ“– æŸ¥çœ‹çµå±€ </button>
     </div>
    </div>

    <div id="page-game" class="page" style="display: none;">
     <div id="story-content" class="rounded-2xl p-4 mb-4 story-box" style="background-color: #fff1f3;">
      <p id="story-text" class="text-base leading-relaxed" style="color: #444; white-space: pre-line;"></p>
     </div>
     <div id="choices-container" class="rounded-2xl p-3" style="background-color: #ffe5ec;">
     </div>
    </div>

    <div id="page-endings" class="page" style="display: none;">
     <h2 class="text-3xl font-bold mb-4 text-center" style="color: #ff6b9d;">ğŸ† çµå±€æ”¶é›†</h2>
     <div id="endings-list" class="space-y-3 mb-4">
     </div>
     <button class="btn w-full py-3 px-4 rounded-xl text-lg font-semibold" style="background-color: #ffb6c9; color: #fff;" onclick="showPage('title')"> â† è¿”å›æ¨™é¡Œ </button>
    </div>

    <div id="page-gameover" class="page" style="display: none;">
     <div class="text-center mb-6">
      <div class="text-6xl mb-4">ğŸ’”</div>
      <h2 id="ending-title" class="text-3xl font-bold mb-2" style="color: #ff6b9d;"></h2>
     </div>
     <div id="ending-description" class="rounded-2xl p-4 mb-4" style="background-color: #fff1f3;">
      <p class="text-base leading-relaxed" style="color: #444;"></p>
     </div>
     <div class="rounded-2xl p-3" style="background-color: #ffe5ec;">
       <button class="btn w-full py-3 px-4 my-2 rounded-xl text-lg font-semibold" style="background-color: #ffb6c9; color: #fff;" onclick="startGame()"> ğŸ”„ é‡æ–°é–‹å§‹ </button> 
       <button class="btn w-full py-3 px-4 my-2 rounded-xl text-lg font-semibold" style="background-color: #ffb6c9; color: #fff;" onclick="showPage('endings')"> ğŸ“– æŸ¥çœ‹çµå±€ </button> 
       <button class="btn w-full py-3 px-4 my-2 rounded-xl text-lg font-semibold" style="background-color: #ffb6c9; color: #fff;" onclick="showPage('title')"> â† è¿”å›æ¨™é¡Œ </button>
     </div>
    </div>
   </div>

   <div class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md p-3 border-t-2" style="background-color: #ffe5ec; border-color: #ffb6c9; z-index: 10;">
    <div class="flex justify-between gap-2">
     <div class="flex-1 rounded-xl p-2 text-center relative" style="background-color: #fff1f3;">
      <button id="save-btn-1" class="w-full py-2 px-2 my-1 rounded-lg text-sm font-semibold border-none" style="background-color: #ffb6c9; color: #fff;" onclick="saveGame(1)"> <span id="save-text-1">ğŸ’¾ å­˜æª”</span> </button> 
      <button id="load-btn-1" class="w-full py-2 px-2 my-1 rounded-lg text-sm font-semibold border-none" style="background-color: #ffb6c9; color: #fff;" onclick="loadGame(1)"> <span id="load-text-1">ğŸ“‚ è®€æª”</span> </button>
      <div class="flex justify-center items-center gap-1 mt-1">
          <div id="save-status-1" class="text-xs" style="color: #555;">æ§½ä½ 1</div>
          <button id="delete-btn-1" class="text-xs text-red-400 hover:text-red-600 font-bold px-1" style="display:none;" onclick="deleteGame(1)" title="åˆªé™¤å­˜æª”">âŒ</button>
      </div>
     </div>
     
     <div class="flex-1 rounded-xl p-2 text-center relative" style="background-color: #fff1f3;">
      <button id="save-btn-2" class="w-full py-2 px-2 my-1 rounded-lg text-sm font-semibold border-none" style="background-color: #ffb6c9; color: #fff;" onclick="saveGame(2)"> <span id="save-text-2">ğŸ’¾ å­˜æª”</span> </button> 
      <button id="load-btn-2" class="w-full py-2 px-2 my-1 rounded-lg text-sm font-semibold border-none" style="background-color: #ffb6c9; color: #fff;" onclick="loadGame(2)"> <span id="load-text-2">ğŸ“‚ è®€æª”</span> </button>
      <div class="flex justify-center items-center gap-1 mt-1">
          <div id="save-status-2" class="text-xs" style="color: #555;">æ§½ä½ 2</div>
          <button id="delete-btn-2" class="text-xs text-red-400 hover:text-red-600 font-bold px-1" style="display:none;" onclick="deleteGame(2)" title="åˆªé™¤å­˜æª”">âŒ</button>
      </div>
     </div>

     <div class="flex-1 rounded-xl p-2 text-center relative" style="background-color: #fff1f3;">
      <button id="save-btn-3" class="w-full py-2 px-2 my-1 rounded-lg text-sm font-semibold border-none" style="background-color: #ffb6c9; color: #fff;" onclick="saveGame(3)"> <span id="save-text-3">ğŸ’¾ å­˜æª”</span> </button> 
      <button id="load-btn-3" class="w-full py-2 px-2 my-1 rounded-lg text-sm font-semibold border-none" style="background-color: #ffb6c9; color: #fff;" onclick="loadGame(3)"> <span id="load-text-3">ğŸ“‚ è®€æª”</span> </button>
      <div class="flex justify-center items-center gap-1 mt-1">
          <div id="save-status-3" class="text-xs" style="color: #555;">æ§½ä½ 3</div>
          <button id="delete-btn-3" class="text-xs text-red-400 hover:text-red-600 font-bold px-1" style="display:none;" onclick="deleteGame(3)" title="åˆªé™¤å­˜æª”">âŒ</button>
      </div>
     </div>
    </div>
   </div>
  </div>

  <script>
    // --- 1. æ¨¡æ“¬ SDK (å·²æ›´æ–°ï¼šæ”¯æ´åˆªé™¤åŠŸèƒ½) ---
    if (!window.dataSdk) {
      window.dataSdk = {
        _listeners: [],
        _data: JSON.parse(localStorage.getItem('peach_rpg_saves') || '[]'),
        
        async init(handler) {
          console.log('%c ğŸ”§ ä½¿ç”¨ LocalStorage æ¨¡æ“¬ SDK ', 'background: #222; color: #bada55');
          this._listeners.push(handler);
          setTimeout(() => handler.onDataChanged(this._data), 50);
          return { isOk: true };
        },

        async create(data) {
          const newRecord = { ...data, id: 'local_' + Date.now() };
          this._data = this._data.filter(r => r.slot_id !== data.slot_id);
          this._data.push(newRecord);
          this._persist();
          return { isOk: true, id: newRecord.id };
        },

        async update(data) {
          const idx = this._data.findIndex(r => r.slot_id === data.slot_id);
          if (idx >= 0) {
            this._data[idx] = { ...this._data[idx], ...data };
            this._persist();
            return { isOk: true };
          }
          return this.create(data);
        },

        // æ–°å¢ï¼šåˆªé™¤åŠŸèƒ½
        async delete(id) {
            this._data = this._data.filter(r => r.id !== id);
            this._persist();
            return { isOk: true };
        },

        _persist() {
          localStorage.setItem('peach_rpg_saves', JSON.stringify(this._data));
          this._listeners.forEach(h => h.onDataChanged(this._data));
        }
      };
    }

    // --- 2. éŠæˆ²ä¸»é‚è¼¯ ---
    
    // Game data and state
    let currentScene = 'start';
    let visitedScenes = new Set();
    let unlockedEndings = new Set();
    let saveSlots = new Map();
    let isLoading = false;

    // Helper function to get current page state
    function getCurrentPage() {
      if (document.getElementById('page-game').style.display === 'block') return 'game';
      if (document.getElementById('page-gameover').style.display === 'block') return 'gameover';
      if (document.getElementById('page-endings').style.display === 'block') return 'endings';
      return 'title';
    }

    const defaultConfig = {
      game_title: "èœœæ¡ƒå¿«é€ƒRPG",
      subtitle: "ä¸€å€‹å……æ»¿å±éšªèˆ‡ç”œèœœçš„å†’éšª",
      save_button_text: "ğŸ’¾ å­˜æª”",
      load_button_text: "ğŸ“‚ è®€æª”",
      surface_color: "#fff1f3",
      text_color: "#444444",
      primary_action_color: "#ffb6c9",
      secondary_action_color: "#ffe5ec"
    };

    // Story data
    const scenes = {
      start: {
        text: "ğŸ‘ ä½ æ˜¯ä¸€é¡†å¹³å¹³ç„¡å¥‡çš„æ°´èœœæ¡ƒï¼Œä»Šå¤©ä¸€æ¨£åœ¨å»šæˆ¿çš„æ°´æœç±ƒè£¡ç•¶å®‰éœçš„ç¾å¥³å­ã€‚çªç„¶å¤©å¤–ä¸€è²é©šé›·éŸ¿âš¡ï¼Œé€™å€‹å®¶çš„å°ä¸»äººçªç„¶é–‹å§‹å¤§å–Šã€Œæˆ‘è¦åƒæ°´èœœæ¡ƒï¼ï¼ã€å®Œè›‹äº†ï¼Œç¾åœ¨æ°´æœç±ƒè£¡åªå‰©ä½ é€™é¡†æ¡ƒï¼Œå†ä¸é€ƒï¼Œæ¡ƒå‘½ä¸ä¿ã€‚\n\nğŸ“‹ ä»»å‹™ç™¼é”ï¼šé€ƒå‡ºæ°´æœç±ƒ\n\né¡¯ç„¶ï¼Œä¸€é¡†æ¡ƒæ˜¯ä¸æœƒèµ°è·¯çš„ï¼Œä½ è©²æ€éº¼å¾æ°´æœç±ƒé€ƒå‡ºå‘¢ï¼Ÿ",
        choices: [
          { text: "âœ¨ æ•£ç™¼æ¡ƒçš„é­…åŠ›ï¼Œè®“å°è²“æŠŠä½ å¼èµ°", next: "cat_charm" },
          { text: "ğŸŒ è®“éš”å£é¦™è•‰ç•¶èª˜é¤Œï¼Œè®“å°è²“æ’ç¿»æ°´æœç±ƒ", next: "banana_bait" }
        ]
      },
      cat_charm: {
        text: "ğŸ˜» ä½ åŠªåŠ›æ•£ç™¼å‡ºèª˜äººçš„æ¡ƒé¦™ï¼Œå°è²“çœŸçš„è¢«å¸å¼•éä¾†äº†ï¼ç‰ å¼µé–‹å˜´å·´ï¼Œéœ²å‡ºå°–éŠ³çš„ç‰™é½’...",
        ending: {
          title: "ğŸ˜¿ çµå±€ä¸€ï¼šè¢«è²“åƒæ‰",
          description: "å¤ªå¤©çœŸäº†ï¼Œä¸æœƒèµ°è·¯çš„ä½ æ€éº¼å¯èƒ½å¾è²“çš„å˜´è£¡é€ƒç”Ÿï¼Ÿå°è²“é–‹å¿ƒåœ°æŠŠä½ ç•¶æˆé›¶é£Ÿåƒæ‰äº†ã€‚ä¸‹æ¬¡è¦å¤šå‹•å‹•è…¦ç­‹å•Šï¼"
        }
      },
      banana_bait: {
        text: "ğŸŒ ä½ ä½¿å‡ºæ¸¾èº«è§£æ•¸èªªæœéš”å£çš„é¦™è•‰å¹«å¿™ï¼Œé¦™è•‰éå¸¸ç¾©æ°£åœ°è‡ªé¡˜ç•¶èª˜é¤Œï¼å°è²“çœ‹åˆ°é¦™è•‰å¾Œèˆˆå¥®åœ°æ’²éä¾†ï¼Œç °çš„ä¸€è²ï¼æ°´æœç±ƒè¢«æ’ç¿»äº†ï¼ä½ å’•åš•å’•åš•æ»¾åˆ°çª—æˆ¶é‚Šã€‚\n\néª¨éª¼ç²¾å¥‡çš„ä½ çªç„¶ç™¼å±•å‡ºäº†å¯ä»¥ç§»å‹•çš„èƒ½åŠ›ï¼å¤ªå¥½äº†ï¼Œé€™æ¨£å°±å¯ä»¥æ›´å®¹æ˜“é€ƒèµ°äº†ã€‚\n\nğŸ“‹ ä»»å‹™ç™¼é”ï¼šé€ƒå‡ºå»šæˆ¿\n\nç¾åœ¨ä½ è©²å¦‚ä½•é›¢é–‹å»šæˆ¿å‘¢ï¼Ÿ",
        choices: [
          { text: "ğŸª´ æ»¾åˆ°çª—æˆ¶æ—é‚Šï¼Œè·³åˆ°ç›†æ ½è£¡", next: "window_escape" },
          { text: "ğŸšª è·³ä¸‹æ¡Œå­ï¼Œå¾å¤§é–€é›¢é–‹", next: "door_escape" }
        ]
      },
      window_escape: {
        text: "ğŸŒ¿ ä½ åŠªåŠ›æ»¾åˆ°çª—æˆ¶é‚Šï¼Œç”¨åŠ›ä¸€è·³ï¼æˆåŠŸè½åœ¨æŸ”è»Ÿçš„ç›†æ ½åœŸè£¡ï¼",
        ending: {
          title: "ğŸŒ± çµå±€äºŒï¼šè¿·èŒ«çš„æ¡ƒ",
          description: "æ­å–œä½ é€ƒå‡ºå¯æ€•çš„å®¶ï¼Œä½†æ˜¯æœªä¾†ä»æ˜¯ä¸€ç‰‡è¿·èŒ«ã€‚ä½ åœ¨ç›†æ ½è£¡ç´®æ ¹ï¼Œé›–ç„¶æœªä¾†ä¸€ç‰‡ç¸¹ç·²ï¼Œä½†æ²’é—œä¿‚ï¼Œæ¡ƒæœƒåŠªåŠ›æ´»è‘—ï¼åœ¨é™½å…‰å’Œé›¨æ°´çš„æ»‹é¤Šä¸‹ï¼Œä½ é–‹å§‹äº†æ–°çš„æ¡ƒç”Ÿã€‚"
        }
      },
      door_escape: {
        text: "ğŸ’¥ ä½ å‹‡æ•¢åœ°è·³ä¸‹æ¡Œå­...ç °ï¼ä½ é‡é‡åœ°æ‘”åœ¨åœ°ä¸Šï¼Œæ„Ÿè¦ºæ•´é¡†æ¡ƒéƒ½æ•£é–‹äº†...",
        ending: {
          title: "ğŸ¥´ çµå±€ä¸‰ï¼šæ¡ƒæ³¥æ³¥",
          description: "å¤ªæœ‰è¶£äº†ï¼Œæ€éº¼æœƒé¸æ“‡é€™å€‹é¸é …å‘¢ï¼Ÿä½ ç¾åœ¨å·²ç¶“ä¸æ˜¯å®Œæ•´çš„æ¡ƒäº†ï¼Œè®Šæˆæ¡ƒæ³¥æ³¥äº†ï¼é›–ç„¶å¤±å»äº†æ¡ƒçš„å½¢æ…‹ï¼Œä½†ç›¸ä¿¡ä½ é‚„ä¿æœ‰æ¡ƒçš„é¦™ç”œ...å§ï¼Ÿ"
        }
      }
    };

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        saveSlots.clear();
        if (Array.isArray(data)) {
            data.forEach(record => {
              if (record && record.slot_id) {
                saveSlots.set(record.slot_id, record);
              }
            });
        }
        updateSaveSlotUI();
      }
    };

    // Initialize SDKs
    async function initializeApp() {
      if (!window.dataSdk) {
         console.warn("Data SDK not found.");
         return; 
      }
      
      const dataResult = await window.dataSdk.init(dataHandler);
      if (!dataResult.isOk) {
        console.error("Failed to initialize Data SDK");
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const title = config.game_title || defaultConfig.game_title;
            const subtitle = config.subtitle || defaultConfig.subtitle;
            const saveText = config.save_button_text || defaultConfig.save_button_text;
            const loadText = config.load_button_text || defaultConfig.load_button_text;
            
            const surfaceColor = config.surface_color || defaultConfig.surface_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
            const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;

            document.getElementById('main-title').textContent = title;
            document.getElementById('main-subtitle').textContent = subtitle;
            
            for (let i = 1; i <= 3; i++) {
              document.getElementById(`save-text-${i}`).textContent = saveText;
              document.getElementById(`load-text-${i}`).textContent = loadText;
            }
            
            document.querySelectorAll('[style*="background-color: #fff1f3"]').forEach(el => {
              el.style.backgroundColor = surfaceColor;
            });
            
            document.querySelectorAll('[style*="color: #444"]').forEach(el => {
              el.style.color = textColor;
            });
            
            document.querySelectorAll('.btn').forEach(el => {
              el.style.backgroundColor = primaryColor;
            });
            
            document.querySelectorAll('[style*="background-color: #ffe5ec"]').forEach(el => {
              el.style.backgroundColor = secondaryColor;
            });

            const bottomBar = document.querySelector('.fixed.bottom-0');
            if(bottomBar) {
                bottomBar.style.backgroundColor = secondaryColor;
                bottomBar.style.borderColor = primaryColor;
            }
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.config.surface_color = value;
                    window.elementSdk.setConfig({ surface_color: value });
                  }
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.config.text_color = value;
                    window.elementSdk.setConfig({ text_color: value });
                  }
                }
              },
              {
                get: () => config.primary_action_color || defaultConfig.primary_action_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.config.primary_action_color = value;
                    window.elementSdk.setConfig({ primary_action_color: value });
                  }
                }
              },
              {
                get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
                set: (value) => {
                  if (window.elementSdk) {
                    window.elementSdk.config.secondary_action_color = value;
                    window.elementSdk.setConfig({ secondary_action_color: value });
                  }
                }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["game_title", config.game_title || defaultConfig.game_title],
            ["subtitle", config.subtitle || defaultConfig.subtitle],
            ["save_button_text", config.save_button_text || defaultConfig.save_button_text],
            ["load_button_text", config.load_button_text || defaultConfig.load_button_text]
          ])
        });
      }
    }

    // Page navigation
    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(page => {
        page.style.display = 'none';
      });
      document.getElementById(`page-${pageName}`).style.display = 'block';
      
      if (pageName === 'endings') {
        displayEndings();
      }
      
      if (pageName === 'gameover') {
        document.body.classList.add('dead');
      } else {
        document.body.classList.remove('dead');
      }
    }

    // Start game
    function startGame() {
      currentScene = 'start';
      visitedScenes.clear();
      visitedScenes.add('start');
      showScene(currentScene);
      showPage('game');
    }

    // Show scene
    function showScene(sceneId, options = {}) {
      const scene = scenes[sceneId];
      if (!scene) return;

      visitedScenes.add(sceneId);
      
      document.getElementById('story-text').textContent = scene.text;
      
      const choicesContainer = document.getElementById('choices-container');
      choicesContainer.innerHTML = '';
      
      if (scene.ending && !options.skipEnding) {
        unlockedEndings.add(sceneId);
        showEnding(scene.ending);
      } else if (scene.choices) {
        scene.choices.forEach(choice => {
          const button = document.createElement('button');
          button.className = 'btn w-full py-3 px-4 my-2 rounded-xl text-lg font-semibold transition-all';
          button.style.backgroundColor = '#ffb6c9';
          button.style.color = '#fff';
          button.textContent = choice.text;
          button.onclick = () => {
            currentScene = choice.next;
            showScene(choice.next);
          };
          choicesContainer.appendChild(button);
        });
      }
    }

    // Show ending
    function showEnding(ending) {
      document.getElementById('ending-title').textContent = ending.title;
      document.getElementById('ending-description').querySelector('p').textContent = ending.description;
      showPage('gameover');
    }

    // Display endings
    function displayEndings() {
      const endingsList = document.getElementById('endings-list');
      endingsList.innerHTML = '';
      
      const allEndings = Object.entries(scenes).filter(([_, scene]) => scene.ending);
      
      allEndings.forEach(([sceneId, scene]) => {
        const endingDiv = document.createElement('div');
        endingDiv.className = 'rounded-xl p-3 mb-3';
        
        if (unlockedEndings.has(sceneId)) {
          endingDiv.style.backgroundColor = '#fff1f3';
          endingDiv.innerHTML = `
            <h3 class="text-xl font-bold mb-2" style="color: #ff6b9d;">${scene.ending.title}</h3>
            <p class="text-sm leading-relaxed" style="color: #444;">${scene.ending.description}</p>
          `;
        } else {
          endingDiv.style.backgroundColor = '#ffe5ec';
          endingDiv.innerHTML = `
            <h3 class="text-xl font-bold mb-2" style="color: #999;">ğŸ”’ æœªè§£é–çµå±€</h3>
            <p class="text-sm" style="color: #666;">ç¹¼çºŒæ¢ç´¢ä»¥è§£é–æ­¤çµå±€...</p>
          `;
        }
        
        endingsList.appendChild(endingDiv);
      });
    }

    // Save game
    async function saveGame(slotId) {
      if (isLoading) return;
      if (!window.dataSdk) {
          alert("ç„¡æ³•å­˜æª”ï¼šSDK æœªè¼‰å…¥");
          return;
      }

      isLoading = true;

      const key = `slot_${slotId}`;
      const statusEl = document.getElementById(`save-status-${slotId}`);
      const saveBtn = document.getElementById(`save-btn-${slotId}`);

      saveBtn.disabled = true;
      statusEl.textContent = 'å„²å­˜ä¸­...';
      statusEl.style.color = '#ff9eb5';

      try {
          const saveData = {
            slot_id: key,
            current_scene: currentScene,
            current_page: getCurrentPage(),
            visited_scenes: JSON.stringify(Array.from(visitedScenes)),
            unlocked_endings: JSON.stringify(Array.from(unlockedEndings)),
            is_dead: document.body.classList.contains('dead'),
            saved_at: Date.now()
          };

          const old = saveSlots.get(key);
          
          let result;
          if (old && old.id) {
            result = await window.dataSdk.update({ ...saveData, id: old.id });
          } else {
            result = await window.dataSdk.create(saveData);
          }

          if (result.isOk) {
            statusEl.textContent = 'å·²å„²å­˜ âœ“';
            statusEl.style.color = '#4ade80';
            if (result.id) saveData.id = result.id;
            saveSlots.set(key, saveData); 
          } else {
            statusEl.textContent = 'å„²å­˜å¤±æ•— âœ—';
            statusEl.style.color = '#ef4444';
          }
      } catch (e) {
          console.error(e);
          statusEl.textContent = 'éŒ¯èª¤ âœ—';
          statusEl.style.color = '#ef4444';
      } finally {
          isLoading = false;
          saveBtn.disabled = false;
          setTimeout(updateSaveSlotUI, 1500);
      }
    }

    // Load game
    async function loadGame(slotId) {
      if (isLoading) return;
      
      const key = `slot_${slotId}`;
      const saveData = saveSlots.get(key);
      const statusEl = document.getElementById(`save-status-${slotId}`);
      const loadBtn = document.getElementById(`load-btn-${slotId}`);

      if (!saveData) {
        statusEl.textContent = 'ç„¡å­˜æª” âœ—';
        statusEl.style.color = '#ef4444';
        setTimeout(updateSaveSlotUI, 1200);
        return;
      }

      isLoading = true;
      loadBtn.disabled = true;
      statusEl.textContent = 'è®€å–ä¸­...';
      statusEl.style.color = '#ff9eb5';

      try {
          currentScene = saveData.current_scene;
          const visitedArr = JSON.parse(saveData.visited_scenes || '[]');
          visitedScenes = new Set(Array.isArray(visitedArr) ? visitedArr : []);

          const unlockedArr = JSON.parse(saveData.unlocked_endings || '[]');
          if (Array.isArray(unlockedArr)) {
             unlockedArr.forEach(e => unlockedEndings.add(e));
          }

          document.body.classList.toggle('dead', !!saveData.is_dead);

          const pageToLoad = saveData.current_page || 'game';
          showPage(pageToLoad);

          if (pageToLoad === 'game') {
            showScene(currentScene, { skipEnding: true });
          }

          if (pageToLoad === 'gameover') {
            const scene = scenes[currentScene];
            if (scene?.ending) {
              document.getElementById('ending-title').textContent = scene.ending.title;
              document.getElementById('ending-description').querySelector('p').textContent = 
                scene.ending.description;
            }
          }
          
          statusEl.textContent = 'å·²è®€å– âœ“';
          statusEl.style.color = '#4ade80';
      } catch (e) {
          console.error("Load failed", e);
          statusEl.textContent = 'è®€å–ææ¯€ âœ—';
          statusEl.style.color = '#ef4444';
      } finally {
          setTimeout(() => {
            isLoading = false;
            loadBtn.disabled = false;
            updateSaveSlotUI();
          }, 800);
      }
    }

    // New: Delete game
    async function deleteGame(slotId) {
      if (isLoading) return;

      const key = `slot_${slotId}`;
      const saveData = saveSlots.get(key);
      
      if (!saveData) return; // æ²’è³‡æ–™å°±ä¸å‹•ä½œ

      // ç°¡å–®ç¢ºèª
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ§½ä½ ${slotId} çš„å­˜æª”å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)) {
          return;
      }

      isLoading = true;
      const statusEl = document.getElementById(`save-status-${slotId}`);
      statusEl.textContent = 'åˆªé™¤ä¸­...';
      
      try {
          // å‘¼å« SDK åˆªé™¤ (éœ€è¦ record id)
          if (saveData.id) {
              await window.dataSdk.delete(saveData.id);
          }
          // æœ¬åœ°å¿«å–æ¸…é™¤
          saveSlots.delete(key);
          
          statusEl.textContent = 'å·²åˆªé™¤';
          statusEl.style.color = '#555';
      } catch (e) {
          console.error("Delete failed", e);
          statusEl.textContent = 'åˆªé™¤å¤±æ•—';
      } finally {
          isLoading = false;
          // é‡æ–°ç¹ªè£½ UI
          updateSaveSlotUI();
      }
    }

    // Update save slot UI (Updated to handle delete button)
    function updateSaveSlotUI() {
      for (let i = 1; i <= 3; i++) {
        const statusEl = document.getElementById(`save-status-${i}`);
        const deleteBtn = document.getElementById(`delete-btn-${i}`);
        if(!statusEl) continue;
        
        const saveData = saveSlots.get(`slot_${i}`);
        
        if (saveData && saveData.saved_at) {
          // æœ‰å­˜æª”
          const dateObj = new Date(saveData.saved_at);
          if (!isNaN(dateObj.getTime())) {
              const timeStr = dateObj.toLocaleString('zh-TW', { 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
              });
              statusEl.textContent = `${timeStr}`;
          } else {
             statusEl.textContent = `æ§½ä½ ${i}`;
          }
          statusEl.style.color = '#555';
          // é¡¯ç¤ºåˆªé™¤æŒ‰éˆ•
          if(deleteBtn) deleteBtn.style.display = 'inline-block';

        } else {
          // ç„¡å­˜æª”
          statusEl.textContent = `æ§½ä½ ${i}`;
          statusEl.style.color = '#999';
          // éš±è—åˆªé™¤æŒ‰éˆ•
          if(deleteBtn) deleteBtn.style.display = 'none';
        }
      }
    }

    // Initialize on load
    initializeApp();
  </script>
 </body>
</html>
